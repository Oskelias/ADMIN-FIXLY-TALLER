<script>
  function showStatus(message, type) {
    const statusDiv = document.getElementById('statusMessage');
    const statusText = document.getElementById('statusText');

    statusText.textContent = message;
    statusDiv.classList.remove('hidden');

    statusDiv.querySelector('div').className = type === 'success'
      ? 'p-4 rounded-lg bg-green-50 border border-green-200'
      : 'p-4 rounded-lg bg-red-50 border border-red-200';

    statusText.className = type === 'success'
      ? 'text-sm text-green-800'
      : 'text-sm text-red-800';
  }

  function hideStatus() {
    document.getElementById('statusMessage').classList.add('hidden');
  }

  // API base: usa VITE_API_URL si existe (Pages), si no usa el dominio productivo
  function getApiBase() {
    // Si en algún momento lo inyectás en build, esto te lo respeta
    const envApi = (typeof import.meta !== 'undefined' && import.meta.env && import.meta.env.VITE_API_URL)
      ? import.meta.env.VITE_API_URL
      : '';
    const base = (envApi || 'https://api.fixlytaller.com').replace(/\/$/, '');
    return base;
  }

  async function safeReadJson(response) {
    const text = await response.text();
    try {
      return { json: JSON.parse(text), text };
    } catch {
      return { json: null, text };
    }
  }

  async function handleLogin(username, password) {
    hideStatus();

    const API = getApiBase();
    const url = `${API}/api/auth/login`;

    console.log('[login] POST', url);

    try {
      const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });

      const { json, text } = await safeReadJson(response);

      console.log('[login] status:', response.status);
      console.log('[login] body:', json ?? text);

      // Aceptamos varias formas de respuesta:
      // 1) { success:true, token, user }
      // 2) { token, user }
      // 3) errores: { error: "..."} o texto
      const token = json?.token;
      const user = json?.user;
      const okBySuccessFlag = json?.success === true;
      const okByToken = typeof token === 'string' && token.length > 10;

      if (response.ok && (okBySuccessFlag || okByToken)) {
        localStorage.setItem('token', token);
        if (user) localStorage.setItem('user', JSON.stringify(user));
        window.location.href = 'index.html';
        return;
      }

      const msg =
        json?.error ||
        json?.message ||
        (typeof text === 'string' && text.trim() ? text : null) ||
        'Error al iniciar sesión';

      showStatus(msg, 'error');
    } catch (err) {
      console.error('[login] fetch error:', err);
      showStatus('Error de conexión con el servidor', 'error');
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('loginForm');
    const usernameInput = document.getElementById('loginUsername');
    const passwordInput = document.getElementById('loginPassword');

    if (!form || !usernameInput || !passwordInput) {
      console.error('[login] form/inputs not found');
      return;
    }

    form.addEventListener('submit', (event) => {
      event.preventDefault();
      const username = usernameInput.value.trim();
      const password = passwordInput.value;
      handleLogin(username, password);
    });
  });
</script>
